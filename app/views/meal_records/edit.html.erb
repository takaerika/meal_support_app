
<%= form_with model: @record, local: true do |f| %>
  <div class="form-group">
    <label>日付</label>
    <%= f.date_field :eaten_on, class: "form-control", required: true %>
  </div>


  <div class="field">
    <%= f.label :slot, "区分" %><br>
    <%= f.select :slot,
               MealRecord.slots.keys.map { |s| [I18n.t("activerecord.enums.meal_record.slot.#{s}"), s] },
               { include_blank: "選択してください" },
               required: true %>
  </div>
  <div>
    <%= f.label :text, "食事内容（テキスト）" %><br>
    <%= f.text_area :text %>

  </div>

  <div class="form-group">
    <label>備考</label>
    <%= f.text_field :note, class: "form-control", placeholder: "外食 / 少なめ など" %>
  </div>

  <div class="form-group">
    <label>現在の写真</label>
    <% if @record.photo.attached? %>
      <div class="current-photo">
        <%= image_tag @record.photo, alt: "現在の写真",
              style: "max-width: 100%; height: auto; border-radius: 8px;" %>
        <div class="current-photo-link">
          <%= link_to "新しいタブで開く", url_for(@record.photo), target: "_blank", rel: "noopener" %>
        </div>
      </div>
    <% else %>
      <p class="muted">（未登録）</p>
    <% end %>
  </div>

  <div class="form-group">
    <label>写真を変更 / 追加</label>
    <%= f.file_field :photo, accept: "image/jpeg,image/png", id: "meal_photo_input", class: "form-control" %>
    <small class="help-text">※ 対応：JPG / PNG ・ 5MB以下</small>

    <div id="meal_photo_preview" class="photo-preview" style="display:none;">
      <img id="meal_photo_preview_img" alt="プレビュー"
           style="max-width:100%; height:auto; border-radius:8px;">
    </div>
  </div>

  <div class="actions">
    <%= f.submit (@record.persisted? ? "更新する" : "登録する"),
          class: "btn-primary" %>
    <%= link_to "キャンセル", (@record.persisted? ? meal_record_path(@record) : patient_home_index_path),
          class: "btn-link" %>
  </div>
<% end %>

<script>
document.addEventListener("turbo:load", setupPhotoPreview);
document.addEventListener("DOMContentLoaded", setupPhotoPreview);

function setupPhotoPreview() {
  var input       = document.getElementById("meal_photo_input");
  var previewWrap = document.getElementById("meal_photo_preview");
  var previewImg  = document.getElementById("meal_photo_preview_img");
  if (!input || !previewWrap || !previewImg) return;

  // 一度だけ登録（Turbo重複対策）
  if (input.dataset.previewBound === "true") return;
  input.dataset.previewBound = "true";

  input.addEventListener("change", function (e) {
    var file = e.target.files && e.target.files[0];
    if (!file) { previewWrap.style.display = "none"; return; }

    if (!["image/jpeg", "image/png"].includes(file.type)) {
      alert("JPG または PNG を選択してください");
      input.value = "";
      previewWrap.style.display = "none";
      return;
    }

    var reader = new FileReader();
    reader.onload = function (ev) {
      previewImg.src = ev.target.result;
      previewWrap.style.display = "block";
    };
    reader.readAsDataURL(file);
  });
}
</script>