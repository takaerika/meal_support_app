<turbo-frame id="record_detail">
  <div data-current-id="<%= @record.id %>"></div>

  <div class="record-show card">
    <header class="record-header">
      <h1 class="h1">食事記録</h1>
      <div class="record-actions">
        <%= link_to '編集',
          edit_meal_record_path(@record),
          class: 'btn btn-secondary',
          data: { turbo_frame: 'record_detail' } %>
      </div>
    </header>

    <section class="record-meta">
      <div class="meta-item">
        <span class="meta-label">日付</span>
        <span class="meta-value"><%= @record.eaten_on.strftime("%Y/%m/%d") %></span>
      </div>

      <div class="meta-item">
        <span class="meta-label">区分</span>
        <span class="chip">
          <%= t("activerecord.enums.meal_record.slot.#{@record.slot}") %>
        </span>
      </div>

      <% if @record.text.present? %>
        <div class="meta-item meta-text">
          <span class="meta-label">内容</span>
          <div class="meta-value"><%= simple_format(@record.text) %></div>
        </div>
      <% end %>

      <% if @record.note.present? %>
        <div class="meta-item meta-text">
        <span class="meta-label">備考</span>
        <div class="meta-value"><%= simple_format(@record.note) %></div>
        </div>
      <% end %>
    </section>

    <%# 写真（あれば） %>
    <% if @record.photo.attached? %>
      <section class="record-photo">
        <figure class="photo">
          <%= image_tag @record.photo, alt: "食事写真", loading: "lazy" %>
          <figcaption class="photo-actions">
            <%= link_to "画像を新しいタブで開く",
                        url_for(@record.photo),
                        target: "_blank", rel: "noopener",
                        class: "btn btn-secondary" %>
          </figcaption>
        </figure>
      </section>
    <% end %>
  </div>

  <%# コメント %>
  <div class="card">
    <h2 class="h2">コメント</h2>

    <% if @record.comments.any? %>
      <ul class="comment-list">
        <% @record.comments.order(created_at: :desc).each do |c| %>
          <li class="comment-item" id="comment-<%= c.id %>">
            <div class="comment-meta">
              <strong class="comment-author"><%= c.user.full_name %></strong>
              <span class="comment-date">
                <%= c.created_at.in_time_zone("Asia/Tokyo").strftime("%Y/%m/%d %H:%M") %>
              </span>
            </div>
            <div class="comment-body"><%= simple_format(h(c.body)) %></div>

            <% if user_signed_in? && current_user.supporter? && c.user_id == current_user.id %>
              <div class="comment-actions">
                <%= link_to "削除",
                            meal_record_comment_path(@record, c),
                            data: { turbo_method: :delete, turbo_confirm: "削除しますか？" } %>
              </div>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="muted">まだコメントはありません</p>
    <% end %>

    <% if user_signed_in? && current_user.supporter? %>
      <div class="comment-form">
        <%= form_with model: [@record, Comment.new], local: true do |f| %>
          <%= f.text_area :body, rows: 3,
                placeholder: "患者さんへのメッセージを入力…（1000文字まで）",
                class: "form-control", required: true %>
          <div class="comment-actions">
            <%= f.submit "コメントを投稿", class: "btn" %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if current_user.supporter? %>
    <div class="record-footer-actions" style="margin-top: 12px;">
      <%= link_to "患者のカレンダーに戻る",
                  supporter_patient_path(@record.patient, date: @record.eaten_on),
                  class: "btn btn-secondary",
                  data: { turbo_frame: "_top" } %>
    </div>
  <% end %>
</turbo-frame>